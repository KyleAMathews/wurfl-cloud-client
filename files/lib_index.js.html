<!DOCTYPE html>
<html lang="en" class="yui-overrride">
<head>
    <meta charset="utf-8">
    <title>lib/index.js - WURFL Cloud Client</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1 class="blue-main-title">WURFL Cloud Client</h1>
        </div>
        <div class="yui3-u-1-4 version project-version">
            API Docs for: 1.1.1
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/WURFLCloudClient.html">WURFLCloudClient</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: lib/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var _assign = require(&#x27;lodash.assign&#x27;),
	_each = require(&#x27;lodash.foreach&#x27;),
	request = require(&#x27;request&#x27;);

// Default configuration
var defaultConfig = {
	host: &#x27;api.wurflcloud.com&#x27;,
	apiKey: &#x27;&#x27;,
	username: &#x27;&#x27;,
	password: &#x27;&#x27;,
	capabilities: [],
	ttl: 30 * 24 * 3600 // 30 days
};

var HEADERS_MAP = {
	&#x27;accept&#x27;: &#x27;X-Accept&#x27;,
	&#x27;x-wap-profile&#x27;: &#x27;x-wap-profile&#x27;,
	&#x27;profile&#x27;: &#x27;x-wap-profile&#x27;,
	&#x27;x-device-user-agent&#x27;: &#x27;X-Device-User-Agent&#x27;,
	&#x27;x-original-user-agent&#x27;: &#x27;X-Original-User-Agent&#x27;,
	&#x27;x-operamini-phone-ua&#x27;: &#x27;X-OperaMini-Phone-UA&#x27;,
	&#x27;x-skyfire-phone&#x27;: &#x27;X-Skyfire-Phone&#x27;,
	&#x27;x-bolt-phone-ua&#x27;: &#x27;X-Bolt-Phone-UA&#x27;
};

// Internal API
var internal = {

	version: require(&#x27;./../package.json&#x27;).version,

	requestFromCloud: function(ua, headers, callback){
		var requestOptions = {
			uri: &#x27;http://&#x27; + client.config.host + &#x27;/v1/json/&#x27;,
			auth: {
				username: client.config.username,
				password: client.config.password
			},
			headers: _assign({
				&#x27;User-Agent&#x27;: ua,
				&#x27;X-Cloud-Client&#x27;: &#x27;nodejs/wurfl-cloud-client &#x27; + internal.version
			}, headers || {}),
			gzip: true
		};

		request(requestOptions, function(err, response, body){
			var data;

			if (err) {
				return callback(err);
			}
			if (response.statusCode !== 200) {
				return callback(body);
			}

			try {
				data = JSON.parse(body);

				delete data.apiVersion;
				delete data.mtime;
				internal.cache(ua, data);

				callback(null, data);
			}
			catch(e) {
				callback(e);
			}
		});
	},

	prepareHeaders: function(req){
		var headers = [],
			ip = (
				req.connection &amp;&amp; req.connection.remoteAddress ?
				req.connection.remoteAddress : // express
				(
					req.info &amp;&amp; req.info.remoteAddress ?
					req.info.remoteAddress :  // hapi
					null
				)
			);

		headers[&#x27;x-forwarded-for&#x27;] = ip;
		if (req.headers[&#x27;x-forwarded-for&#x27;]) {
			headers[&#x27;x-forwarded-for&#x27;] += &#x27;,&#x27; + req.headers[&#x27;x-forwarded-for&#x27;];
		}

		_each(HEADERS_MAP, function(resKey, reqKey){
			if (req.headers[reqKey]) {
				headers[resKey] = req.headers[reqKey];
			}
		});

		return headers;
	},

	cached: function(ua, callback) {
		if (client.cache) {
			client.cache.get(&#x27;device:&#x27; + ua.replace(/:/g, &#x27;_&#x27;), callback);
		}
		else {
			callback(null, false);
		}
	},

	cache: function(ua, device) {
		if (client.cache) {
			client.cache.set(&#x27;device:&#x27; + ua.replace(/:/g, &#x27;_&#x27;), device, client.config.ttl);
		}
	}

};

/**
 * WURFL Cloud client module
 *
 * @class WURFLCloudClient
 */
var client = module.exports = {

	/**
	 * The config object
	 *
	 * @property config
	 * @type {Object}
	 */
	config: null,

	/**
	 * The cache interface used to save detections results.
	 *
	 * The implementation of the cache layer is left up to the application using this module.
	 *
	 * All it needs to expose in this interface is two methods: &#x60;get&#x60; and &#x60;set&#x60;.
	 *
	 * The cache key will be set to &#x60;device:UA&#x60; where &#x60;UA&#x60; is the User-Agent string with
	 * all instances of the &#x60;:&#x60; character replaced by &#x60;_&#x60;, to play nice with Redis keys.
	 *
	 * The TTL for storing these cached values can be defined in the configuration, default is 30 days.
	 *
	 * @example
	 *
	 *     client.cache = {
	 *         get: function(key, callback) {},
	 *         set: function(key, value, ttl) {}
	 *     };
	 *
	 * @property cache
	 * @type {Object}
	 */
	cache: null,

	/**
	 * Configure the module
	 *
	 * An API key can be either sent as &#x60;apiKey&#x60; in &#x60;username:password&#x60; format
	 * or as individual &#x60;username&#x60; and &#x60;password&#x60; properties.
	 *
	 * @example
	 *
	 *     client.configure({
	 *         host: &#x27;custom-wurfl-cloud-host.com&#x27;,
	 *         apiKey: &#x27;foobar:1234567890&#x27;
	 *     });
	 *
	 *     client.configure({
	 *         username: &#x27;foobar&#x27;,
	 *         password: &#x27;1234567890&#x27;
	 *     });
	 *
	 * @static
	 * @method configure
	 * @param  {Object} configuration
	 */
	configure: function(configuration) {
		var parts;

		client.config = _assign(_assign({}, defaultConfig), configuration);

		if (client.config.apiKey) {
			parts = client.config.apiKey.split(&#x27;:&#x27;);
			client.config.username = parts[0];
			client.config.password = parts[1];
		}
	},

	/**
	 * Detect a device by user agent
	 *
	 * @example
	 *
	 *     client.detectDevice(userAgent, function(err, result) {
	 *         // result is part of the response from WURFL cloud
	 *     });
	 *
	 *     client.detectDevice(userAgent, {
	 *         &#x27;X-Extra-Header&#x27;: &#x27;Wow!&#x27;
	 *     }, function(err, result) {
	 *         // result is part of the response from WURFL cloud
	 *     });
	 *
	 * @static
	 * @method detectDevice
	 * @param  {String}   ua       User Agent string
	 * @param  {Object}   [headers]  Extra HTTP headers
	 * @param  {Function} callback Callback gets called with &#x60;(err, result)&#x60;
	 */
	detectDevice: function(ua, headers, callback) {
		if (!client.config) {
			client.configure({});
		}

		if (!arguments[2]) {
			callback = headers;
			headers = {};
		}

		internal.cached(ua, function(err, result){
			if (err || !result) {
				internal.requestFromCloud(ua, headers, callback);
			}
			else {
				callback(null, result);
			}
		});
	},

	/**
	 * Middleware for &#x60;connect&#x60;/&#x60;express&#x60;-based applications.
	 *
	 * It populates a &#x60;capabilities&#x60; on the &#x60;request&#x60; parameter,
	 * containing the &#x60;capabilities&#x60; object from the WURFL Cloud response.
	 *
	 * @example
	 *
	 *     var app = express();
	 *     app.use(client.middleware({
	 *         apiKey: &#x27;...&#x27;
	 *     }));
	 *     app.get(&#x27;/&#x27;, function(req) {
	 *         // req.capabilities is populated now
	 *     });
	 *
	 * @static
	 * @method middleware
	 * @param  {Object} [configuration]
	 * @return {Function} The middleware function that takes in the arguments &#x60;(req, res, next)&#x60;
	 */
	middleware: function(configuration){
		if (!client.config || configuration) {
			client.configure(configuration);
		}

		return function(req, res, next) {
			client.detectDevice(
				req.headers[&#x27;user-agent&#x27;],
				internal.prepareHeaders(req),
				function(err, result){
					if (!err &amp;&amp; result.capabilities) {
						req.capabilities = result.capabilities;
					}
					next();
				}
			);
		};
	},

	/**
	 * Hapi plugin
	 *
	 * It populates a &#x60;capabilities&#x60; on the &#x60;request&#x60; parameter,
	 * containing the &#x60;capabilities&#x60; object from the WURFL Cloud response.
	 *
	 * @example
	 *
	 *     var Hapi = require(&#x27;hapi&#x27;);
	 *     var server = new Hapi.Server();
	 *     server.pack.register({
	 *         plugin: require(&#x27;wurfl-cloud-client&#x27;),
	 *         options: {
	 *             apiKey: &#x27;...&#x27;
	 *         }
	 *     });
	 *     server.route({
	 *         method: &#x27;GET&#x27;,
	 *         path: &#x27;/&#x27;,
	 *         handler: function(request, reply) {
	 *             // request.capabilities is populated now
	 *         }
	 *     });
	 *
	 * @static
	 * @method register
	 * @param  {Hapi} plugin
	 * @param  {Object} options
	 * @param  {Function} next
	 */
	register: function(plugin, options, next) {
		if (!client.config || options) {
			client.configure(options);
		}

		plugin.ext(&#x27;onRequest&#x27;, function(request, extNext) {
			client.detectDevice(
				request.headers[&#x27;user-agent&#x27;],
				internal.prepareHeaders(request),
				function(err, result){
					if (!err &amp;&amp; result.capabilities) {
						request.capabilities = result.capabilities;
					}
					extNext();
				}
			);
		});

		next();
	}

};

module.exports.register.attributes = {
	pkg: require(&#x27;../package.json&#x27;)
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
